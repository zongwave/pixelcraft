# è‡ªåŠ¨æ›å…‰(Auto Exposure, AE) æŠ€æœ¯æ€»ç»“

## ç›®å½•
- [è‡ªåŠ¨æ›å…‰(Auto Exposure, AE) æŠ€æœ¯æ€»ç»“](#è‡ªåŠ¨æ›å…‰auto-exposure-ae-æŠ€æœ¯æ€»ç»“)
  - [ç›®å½•](#ç›®å½•)
  - [1. AE ç®—æ³•æ ¸å¿ƒç›®æ ‡](#1-ae-ç®—æ³•æ ¸å¿ƒç›®æ ‡)
    - [ç‰©ç†å®šä¹‰](#ç‰©ç†å®šä¹‰)
    - [äººçœ¼æ„ŸçŸ¥åŸºç¡€](#äººçœ¼æ„ŸçŸ¥åŸºç¡€)
    - [äººçœ¼äº®åº¦æ„ŸçŸ¥å¯¹æ•°å“åº”æ›²çº¿](#äººçœ¼äº®åº¦æ„ŸçŸ¥å¯¹æ•°å“åº”æ›²çº¿)
      - [Weberâ€“Fechner å®šå¾‹](#weberfechner-å®šå¾‹)
  - [2. ç›¸æœºæ›å…‰ä¸­çš„åº”ç”¨](#2-ç›¸æœºæ›å…‰ä¸­çš„åº”ç”¨)
  - [3. ä¸»æµ AE ç®—æ³•åˆ†ç±»](#3-ä¸»æµ-ae-ç®—æ³•åˆ†ç±»)
    - [3.1 åŸºäºç»Ÿè®¡çš„ AE](#31-åŸºäºç»Ÿè®¡çš„-ae)
      - [åŸºäºç›´æ–¹å›¾çš„ AE æ§åˆ¶ç­–ç•¥](#åŸºäºç›´æ–¹å›¾çš„-ae-æ§åˆ¶ç­–ç•¥)
      - [å³°è°·å¹³è¡¡](#å³°è°·å¹³è¡¡)
      - [åŒå³°åˆ†ç¦»](#åŒå³°åˆ†ç¦»)
      - [è‡ªé€‚åº”æƒé‡ç›´æ–¹å›¾](#è‡ªé€‚åº”æƒé‡ç›´æ–¹å›¾)
    - [3.2 å¤šé‡æ›å…‰èåˆæŠ€æœ¯å¯¹æ¯”](#32-å¤šé‡æ›å…‰èåˆæŠ€æœ¯å¯¹æ¯”)
  - [4. è¯„ä¼°æŒ‡æ ‡](#4-è¯„ä¼°æŒ‡æ ‡)
    - [4.1 å®¢è§‚æŒ‡æ ‡](#41-å®¢è§‚æŒ‡æ ‡)
    - [4.2 ä¸»è§‚æ ‡å‡†](#42-ä¸»è§‚æ ‡å‡†)
  - [5. AEè°ƒä¼˜](#5-aeè°ƒä¼˜)
    - [æ ¸å¿ƒæ¡†æ¶](#æ ¸å¿ƒæ¡†æ¶)
    - [5.1 åŸºç¡€å‚æ•°æ ¡å‡†](#51-åŸºç¡€å‚æ•°æ ¡å‡†)
      - [æ›å…‰åŸºå‡†è®¾å®š](#æ›å…‰åŸºå‡†è®¾å®š)
      - [åŠ¨æ€åŸºå‡†è°ƒæ•´ï¼ˆç°ä»£AIç›¸æœºï¼‰](#åŠ¨æ€åŸºå‡†è°ƒæ•´ç°ä»£aiç›¸æœº)
    - [5.2 åœºæ™¯é€‚åº”æ€§ä¼˜åŒ–](#52-åœºæ™¯é€‚åº”æ€§ä¼˜åŒ–)
    - [5.3 ä¸»è§‚ç”»è´¨è°ƒä¼˜](#53-ä¸»è§‚ç”»è´¨è°ƒä¼˜)
      - [å…³é”®æŒ‡æ ‡æµ‹è¯•](#å…³é”®æŒ‡æ ‡æµ‹è¯•)
      - [é«˜å…‰æ¸å˜æ§åˆ¶](#é«˜å…‰æ¸å˜æ§åˆ¶)
    - [5.4 Exposure Time ä¸ Gain è”åˆè°ƒæ•™ç­–ç•¥](#54-exposure-time-ä¸-gain-è”åˆè°ƒæ•™ç­–ç•¥)
      - [è‡ªåŠ¨é˜¶æ¢¯ç®—æ³•](#è‡ªåŠ¨é˜¶æ¢¯ç®—æ³•)

---

## 1. AE ç®—æ³•æ ¸å¿ƒç›®æ ‡
è‡ªåŠ¨è°ƒèŠ‚ç›¸æœºæ›å…‰ä¸‰è¦ç´ ï¼ˆå¿«é—¨ $t$ã€å…‰åœˆ $F$ã€ISO $G$ï¼‰ï¼Œä½¿å›¾åƒäº®åº¦ $Y$ é€¼è¿‘ç›®æ ‡å€¼ï¼š

$$
Y_{\text{target}} = 0.18 Ã— (Y_{\text{max}} - Y_{\text{black}}) + Y_{\text{black}}
$$

- $Y_{\text{max}}$ï¼šä¼ æ„Ÿå™¨åœ¨å½“å‰æ›å…‰ä¸‹çš„æœ€å¤§é‡åŒ–äº®åº¦ï¼ˆ8-bit å›¾åƒä¸º 255ï¼‰ã€‚
- $Y_{\text{black}}$ï¼šé»‘ç”µå¹³(black-level)ã€‚
- $Y_{\text{target}}$ï¼šæœŸæœ›äº®åº¦ï¼Œ8-bitã€black-levelä¸º0æ—¶ï¼Œå¯¹åº” 46/255ï¼ˆâ‰ˆ18 % ç°ï¼‰ã€‚

### ç‰©ç†å®šä¹‰
- **18 % ä¸­æ€§ç°å¡**ï¼ˆKodak Gray Cardï¼‰è¢«å›½é™…æ ‡å‡†åŒ–ä¸ºå…‰å­¦åå°„ç‡ 18 % çš„ä¸­æ€§å‚è€ƒã€‚
- è¯¥å€¼ä½äºå…¸å‹åœºæ™¯å¹³å‡åå°„ç‡åˆ†å¸ƒçš„ 50 % åˆ†ä½ï¼Œå…¼é¡¾é«˜å…‰ä¸é˜´å½±ç»†èŠ‚ã€‚

### äººçœ¼æ„ŸçŸ¥åŸºç¡€
äººçœ¼å¯¹äº®åº¦çš„æ„ŸçŸ¥å‘ˆå¯¹æ•°å‹ç¼©ï¼ˆWeberâ€“Fechner å®šå¾‹ï¼‰ï¼š

- **æš—è§†è§‰ (Scotopic)**ï¼š$k \approx 0.01$ï¼Œä¸»è¦ç”±æ†çŠ¶ç»†èƒé©±åŠ¨ã€‚
- **æ˜è§†è§‰ (Photopic)**ï¼š$k \approx 0.1$ï¼Œä¸»è¦ç”±é”¥çŠ¶ç»†èƒé©±åŠ¨ã€‚
- **è¿‡æ¸¡åŒº (Mesopic)**ï¼š18 % ç°å¡å¤„äºäººçœ¼æœ€æ•æ„ŸåŒºé—´ï¼Œä¿è¯æœ€ä½³å¯¹æ¯”åº¦ã€‚

### äººçœ¼äº®åº¦æ„ŸçŸ¥å¯¹æ•°å“åº”æ›²çº¿

#### Weberâ€“Fechner å®šå¾‹
$$
\frac{\Delta I}{I} = k \quad (\text{æœ€å°å¯è§‰å·® JND})
$$

| äº®åº¦èŒƒå›´ (cd/mÂ²) | è§†è§‰æ¨¡å¼ | æœ€å°å¯è§‰å·® $k$ | 18 % ç°åŒºåŸŸ |
|------------------|----------|----------------|-------------|
| $10^{-2}$ â€“ $10^{0}$ | æš—è§†è§‰   | 0.01           | Ã—           |
| $10^{0}$ â€“ $10^{2}$  | è¿‡æ¸¡åŒº   | 0.018          | âœ” æ ¸å¿ƒåŒº    |
| $10^{2}$ â€“ $10^{6}$  | æ˜è§†è§‰   | 0.1            | Ã—           |

> [![Weber-Fechneräº®åº¦å“åº”æ›²çº¿](diagram/Weber-Fechner_curve.png)](https://github.com/zongwave/notes/blob/main/3a/diagram/Weber-Fechner_curve.png)

---

## 2. ç›¸æœºæ›å…‰ä¸­çš„åº”ç”¨

| åœºæ™¯ç±»å‹   | è°ƒæ•´ç­–ç•¥                              | ç¤ºä¾‹           |
|------------|---------------------------------------|----------------|
| æ­£å¸¸å…‰ç…§   | å…¨å±€äº®åº¦é€¼è¿‘ 18 % ç°                  | ç™½å¤©é£æ™¯       |
| é«˜åŠ¨æ€èŒƒå›´ | é«˜å…‰ < 90 %ï¼Œæš—éƒ¨ > 5 %               | é€†å…‰äººåƒ       |
| ä½å…‰ç…§     | æ•´ä½“äº®åº¦å¯ä¸‹è°ƒè‡³ 12 %ï¼Œä¼˜å…ˆé™å™ª       | å¤œæ™¯æ‰‹æŒ       |

---

## 3. ä¸»æµ AE ç®—æ³•åˆ†ç±»

### 3.1 åŸºäºç»Ÿè®¡çš„ AE

| ç®—æ³•       | åŸç†                                          | ä¼˜ç‚¹             | ç¼ºç‚¹               |
|------------|-----------------------------------------------|------------------|--------------------|
| å…¨å±€å¹³å‡   | $\text{EV}_{\text{comp}} = \log_2\frac{Y_{\text{tgt}}}{\bar Y}$ | ç®€å•ã€å¿«é€Ÿ       | æ˜“å—æç«¯å€¼å½±å“     |
| åŒºåŸŸåŠ æƒ   | $\bar Y = \sum_i w_i \cdot Y_i,\; w_{\text{center}} > w_{\text{edge}}$ | ç¬¦åˆäººçœ¼æ³¨æ„æœºåˆ¶ | éœ€æ ‡å®šæƒé‡         |
| ç›´æ–¹å›¾æ³•   | ä¾æ®ç›´æ–¹å›¾åˆ†å¸ƒé˜²æ­¢æˆªæ–­                        | é²æ£’             | è®¡ç®—é‡è¾ƒå¤§         |

#### åŸºäºç›´æ–¹å›¾çš„ AE æ§åˆ¶ç­–ç•¥

- **SNR æ¨¡å‹**  
   $$
   \text{SNR} = \frac{S}{\sqrt{N_{\text{shot}}^{2} + N_{\text{read}}^{2} + (K \cdot G)^{2}}}
   $$

- **ç›´æ–¹å›¾ç»Ÿè®¡**  
   ```python
   def calc_histogram(y: np.ndarray, bins: int = 256) -> np.ndarray:
       hist, _ = np.histogram(y, bins=bins, range=(0, 255))
       return hist / y.size  # å½’ä¸€åŒ–
   ```

- **å…³é”®ç­–ç•¥**

| ç­–ç•¥ç±»å‹ | å®ç°æ–¹å¼ | æ•°å­¦è¡¨è¾¾å¼ / é€»è¾‘ |
|---|---|---|
| å‡å€¼åŒ¹é… | è°ƒæ•´æ›å…‰ä½¿ç›´æ–¹å›¾å‡å€¼è¶‹è¿‘ç›®æ ‡å€¼ï¼ˆå¦‚ 46/255ï¼‰ | `EV_comp = log2(Y_target / Y_mean)` |
| å³°è°·å¹³è¡¡ | é¿å…ç›´æ–¹å›¾ä¸¤ç«¯å †ç§¯ï¼ˆé˜²æ­¢è¿‡æ›/æ¬ æ›ï¼‰ | `Î”EV = 0.3 * (ğŸ™{hist[0]/N > 0.05} âˆ’ ğŸ™{hist[255]/N > 0.05})` |
| åŒå³°åˆ†ç¦» | è¯†åˆ«ä¸»ä½“/èƒŒæ™¯åŒå³°ï¼Œä¼˜åŒ–ä¸»ä½“å³°ä½ç½® | `Î”EV = argmax(hist) âˆ’ 110` |
| åŠ¨æ€èŒƒå›´ä¼˜åŒ– | ç¡®ä¿ç›´æ–¹å›¾è¦†ç›–æœ‰æ•ˆèŒƒå›´ï¼ˆ5 %â€“95 % åŒºé—´æœ‰åˆ†å¸ƒï¼‰ | `EV_comp = (hist[5 %] > 0) ? +0.3 : (hist[95 %] < 0.01) ? âˆ’0.3 : 0` |

#### å³°è°·å¹³è¡¡
- **èƒŒæ™¯**ï¼šç›´æ–¹å›¾æœ€å·¦ï¼ˆ0ï¼‰å’Œæœ€å³ï¼ˆ255ï¼‰å¦‚æœå †äº†å¾ˆå¤šåƒç´ ï¼Œè¯´æ˜ç”»é¢æœ‰å¤§ç‰‡æ­»é»‘æˆ–æ­»ç™½ï¼Œå±äºè¿‡æ›/æ¬ æ›ã€‚  
- **åšæ³•**ï¼šæŠŠ 0 å’Œ 255 ä¸¤ä¸ª bin çš„åƒç´ åŠ èµ·æ¥ï¼Œå¦‚æœè¶…è¿‡æ€»åƒç´ æ•°çš„ 10 %ï¼ˆ0.1ï¼‰ï¼Œå°±è®¤ä¸ºâ€œå µæ­»â€äº†ã€‚  
- **å¯¹ç­–**ï¼šç›´æ¥ç»™æ•´å¼ ç…§ç‰‡æ‹‰ä½ 0.5 EVï¼ˆ`adjust_EV(-0.5)`ï¼‰ï¼Œè®©æ•´ä½“å¾€æš—éƒ¨æŒªä¸€ç‚¹ï¼Œå‡å°‘é«˜å…‰æº¢å‡ºã€‚  

ä¸€å¥è¯ï¼šçœ‹åˆ°â€œä¸¤å¤´ç¿˜â€å°±å…ˆæŠŠæ›å…‰é™åŠæ¡£ï¼Œæ•‘é«˜å…‰ã€‚

#### åŒå³°åˆ†ç¦»
- **èƒŒæ™¯**ï¼šå¾ˆå¤šåœºæ™¯ä¸»ä½“å’ŒèƒŒæ™¯äº®åº¦å·®ä¸€å¤§æˆªï¼Œç›´æ–¹å›¾ä¼šå‡ºç°å·¦å³å„ä¸€ä¸ªâ€œé©¼å³°â€ã€‚  
- **ç›®æ ‡**ï¼šæŠŠä»£è¡¨ä¸»ä½“çš„é‚£ä¸ªå³°æŒªåˆ° 8-bit çš„ä¸­æ®µï¼ˆç»éªŒå€¼ 110 é™„è¿‘ï¼‰ï¼Œè¿™æ ·ä¸»ä½“ç»†èŠ‚æœ€å¥½ã€‚  
- **å¯¹ç­–**ï¼šå…ˆæ‰¾ç›´æ–¹å›¾é‡Œæœ€é«˜çš„é‚£ä¸ªå³° `argmax(hist)`ï¼Œå‡è®¾å®ƒå°±æ˜¯ä¸»ä½“å³°ã€‚è®¡ç®—è¿™ä¸ªå³°åˆ° 110 çš„è·ç¦»ï¼š`Î”EV = argmax(hist) âˆ’ 110`ã€‚æŒ‰ `Î”EV` è°ƒæ•´æ›å…‰ï¼ˆæ­£æ•°å°±åŠ å…‰ï¼Œè´Ÿæ•°å°±å‡å…‰ï¼‰ï¼ŒæŠŠä¸»ä½“æ¨åˆ°ä¸­é—´ã€‚  

#### è‡ªé€‚åº”æƒé‡ç›´æ–¹å›¾
```python
def weighted_histogram(y_channel, roi_mask):
    weights = np.where(roi_mask, 1.0, 0.3)  # æ ¸å¿ƒåŒºåŸŸæƒé‡é«˜
    hist = np.bincount(y_channel.flatten(),
                       weights=weights.flatten(),
                       minlength=256)
    return hist / np.sum(weights)
```


### 3.2 å¤šé‡æ›å…‰èåˆæŠ€æœ¯å¯¹æ¯”

| æŠ€æœ¯æ–¹æ¡ˆ               | å®ç°åŸç†                     | é€‚ç”¨åœºæ™¯          | æŠ€æœ¯ç‰¹æ€§                  |
|------------------------|----------------------------|-----------------|--------------------------|
| ä¼ ç»ŸHDRåˆæˆ            | å¤šå¸§ä¸åŒEVå€¼åˆæˆ            | é™æ€é«˜åŠ¨æ€åœºæ™¯  | éœ€ä¸‰è„šæ¶ï¼Œé«˜ç”»è´¨          |
| æ™ºèƒ½å¤šå¸§èåˆ           | çŸ­/ä¸­/é•¿æ›å…‰å¸§åŠ¨æ€èåˆ       | ç§»åŠ¨æ‘„å½±        | æ‰‹æŒä¼˜åŒ–ï¼Œè®¡ç®—æ‘„å½±åŠ æŒ     |
| ä¼ æ„Ÿå™¨çº§éš”è¡Œæ›å…‰(PDAF) | å•å¸§å†…äº¤æ›¿æ›å…‰è¡Œç¡¬ä»¶åˆæˆ     | é«˜é€Ÿè¿åŠ¨æ‹æ‘„    | é›¶æ—¶å·®ï¼Œåˆ†è¾¨ç‡éƒ¨åˆ†ç‰ºç‰²     |
| åƒç´ çº§åŒæ›å…‰           | å•ä¸ªåƒç´ åˆ†æ—¶é•¿çŸ­æ›å…‰(å¦‚Sony IMX689)| ä¸“ä¸šè§†é¢‘      | é«˜å¸§ç‡ï¼Œä½å™ªç‚¹            |

---

## 4. è¯„ä¼°æŒ‡æ ‡

### 4.1 å®¢è§‚æŒ‡æ ‡
- æ”¶æ•›é€Ÿåº¦ï¼š`<300 ms`ï¼ˆ4K@30fpsï¼‰
- äº®åº¦ç¨³å®šæ€§ï¼š`Î”Y < 5 %`ï¼ˆè¿ç»­100å¸§ï¼‰

### 4.2 ä¸»è§‚æ ‡å‡†
- æ— å¯è§é—ªçƒï¼ˆ`<0.5 %` äº®åº¦æ³¢åŠ¨ï¼‰
- é«˜å…‰ä¿ç•™ï¼ˆ`clipping < 2 %`ï¼‰

---

## 5. AEè°ƒä¼˜

### æ ¸å¿ƒæ¡†æ¶
![AE Tuningæ ¸å¿ƒæ¡†æ¶](diagram/ae_tunning.png)

---

### 5.1 åŸºç¡€å‚æ•°æ ¡å‡†

#### æ›å…‰åŸºå‡†è®¾å®š
18%ç°å¡æ³•ï¼š
```python
def set_exposure_target():
    while abs(avg_luma - 46) > 2:  # 8bitä¸‹46=255*0.18
        adjust_exposure(step=0.1)
```

#### åŠ¨æ€åŸºå‡†è°ƒæ•´ï¼ˆç°ä»£AIç›¸æœºï¼‰
$$
Y_{\text{target}} = 0.18 \times (1 + 0.5 \cdot S_{\text{scene}})
$$

- $S$ï¼šåœºæ™¯ç±»å‹ç³»æ•°  
  - é€†å…‰ï¼š`+0.3`  
  - å¤œæ™¯ï¼š`-0.2`  
  - æ­£å¸¸ï¼š`0`

---

### 5.2 åœºæ™¯é€‚åº”æ€§ä¼˜åŒ–

| æŠ€æœ¯               | å®ç°æ–¹å¼                     | å‚æ•°è°ƒæ•´è¦ç‚¹               |
|--------------------|----------------------------|--------------------------|
| å±€éƒ¨è‰²è°ƒæ˜ å°„       | åˆ†åŒºåŸŸ Î³ å€¼è°ƒæ•´               | é«˜å…‰åŒº Î³=0.8ï¼Œé˜´å½±åŒº Î³=1.2 |
| åŒåŸç”ŸISO          | é«˜ä½ISOåƒç´ çº§èåˆ           | åˆ‡æ¢é˜ˆå€¼ï¼š80 % æ»¡é˜±å®¹é‡    |
| æ—¶åŸŸé™å™ª+AEè”åˆ    | è¿åŠ¨æ£€æµ‹ â†’ åŠ¨æ€æ›å…‰è¡¥å¿     | è¿åŠ¨é˜ˆå€¼ï¼š5 px/frame       |

---

### 5.3 ä¸»è§‚ç”»è´¨è°ƒä¼˜

#### å…³é”®æŒ‡æ ‡æµ‹è¯•
- **æ”¶æ•›é€Ÿåº¦æµ‹è¯•**  
  ä»æš—åˆ°äº®ï¼ˆ0â†’1000 luxï¼‰éœ€ < 300 msï¼Œè¿‡å†²å¹…åº¦ < 5 %ã€‚

- **ç¨³å®šæ€§æµ‹è¯•**  
  ```python
  def check_flicker(frames):
      luma_std = np.std([calc_luma(f) for f in frames])
      return luma_std < 2.5   # å•ä½ï¼š%


#### äººçœ¼æ•æ„ŸåŒºä¼˜åŒ–
- **è‚¤è‰²ä¿æŠ¤ï¼ˆCbCræ¤­åœ†çº¦æŸï¼‰**  
  åœ¨ YCbCr è‰²å½©ç©ºé—´çš„è‰²åº¦å¹³é¢ï¼ˆCb-Crï¼‰ä¸­ï¼Œäººç±»è‚¤è‰²é›†ä¸­åœ¨ç‰¹å®šæ¤­åœ†åŒºåŸŸå†…ï¼š  
  $$
  \frac{(Cb - 156)^2}{8^2} + \frac{(Cr - 120)^2}{7^2} \leq 1
  $$
- **èƒŒå…‰äººè„¸è¡¥å¿**  
  ```python
  if backlit_face_detected:
    Y_target *= 1.2   # æå‡çº¦ +0.26 EV
  ```


#### é«˜å…‰æ¸å˜æ§åˆ¶
```python
if highlight > 0.9:
    apply_soft_clip(curve="sigmoid", knee_point=0.85)
```

### 5.4 Exposure Time ä¸ Gain è”åˆè°ƒæ•™ç­–ç•¥

| é˜¶æ®µ | ä¼˜å…ˆçº§ | å¯è°ƒé‡ | ä¸Šé™ / æ¡ä»¶ | å‰¯ä½œç”¨ | å¤‡æ³¨ |
|---|---|---|---|---|---|
| 1. å»¶é•¿æ›å…‰æ—¶é—´ | æœ€é«˜ | $t$ | $t_{\max}=1/(2 \cdot v_{\text{motion}})$ | è¿åŠ¨æ¨¡ç³Š | $v_{\text{motion}}$ ä¸ºåƒç´ /å¸§é€Ÿåº¦ |
| 2. æ¨¡æ‹Ÿå¢ç›Š | æ¬¡é«˜ | $G_{\text{analog}}$ | $G_{\max}= \text{sensor åŸç”Ÿ ISO}/100$ | è¯»å‡ºå™ªå£°â†‘ | æ¯ 6 dB â‰ˆ1 bit å™ªå£° |
| 3. æ•°å­—å¢ç›Š | æœ€å | $G_{\text{digital}}$ | æ— ç¡¬æ€§ä¸Šé™ | ä¿¡å™ªæ¯”â†“ | æ¯ 6 dB SNR æŸå¤± 30 % |

#### è‡ªåŠ¨é˜¶æ¢¯ç®—æ³•
```python
def auto_exposure_strategy(target_ev, motion_px_per_frame):
    max_time = 1.0 / (2.0 * motion_px_per_frame)   # é˜²ç³Š
    best_time = min(target_ev, max_time)
    remain_ev = target_ev - best_time

    if remain_ev <= 0:
        return best_time, 1.0   # çº¯æ›å…‰æ—¶é—´

    max_ag = get_native_iso() / 100
    best_ag = min(remain_ev, max_ag)
    remain_ev -= best_ag

    best_dg = 1.0 if remain_ev <= 0 else remain_ev
    return best_time, best_ag * best_dg
```