
## ğŸ“‘ ç›®å½•

- [Intel Gaudi 3 AI åŠ é€Ÿå™¨å…³é”®è§„æ ¼æ€»ç»“ï¼ˆé¢å‘å¤§æ¨¡å‹æ¨ç†éƒ¨ç½²ï¼‰](#intel-gaudi-3-ai-åŠ é€Ÿå™¨å…³é”®è§„æ ¼æ€»ç»“é¢å‘å¤§æ¨¡å‹æ¨ç†éƒ¨ç½²)
  - [ğŸ“Œ æ ¸å¿ƒè®¡ç®—èƒ½åŠ›](#æ ¸å¿ƒè®¡ç®—èƒ½åŠ›)
  - [ğŸ§  å­˜å‚¨ä¸å¸¦å®½](#å­˜å‚¨ä¸å¸¦å®½)
  - [ğŸ”Œ I/O ä¸ç³»ç»Ÿäº’è”](#io-ä¸ç³»ç»Ÿäº’è”)
  - [âš™ï¸ æ¶æ„ç‰¹æ€§ä¸ä¼˜åŒ–é‡ç‚¹](#ï¸æ¶æ„ç‰¹æ€§ä¸ä¼˜åŒ–é‡ç‚¹)
  - [âœ… æ¨ç†éƒ¨ç½²ä¼˜åŒ–å»ºè®®](#æ¨ç†éƒ¨ç½²ä¼˜åŒ–å»ºè®®)
- [Intel Gaudi 3 AI åŠ é€Ÿå™¨æ¶æ„æ¦‚è¦ï¼šMME ä¸ TPC æ¨¡å—](#intel-gaudi-3-ai-åŠ é€Ÿå™¨æ¶æ„æ¦‚è¦)
  - [ğŸ“Œ MMEï¼ˆMatrix Multiplication Engineï¼‰](#mmematrix-multiplication-engine)
  - [ğŸ“Œ TPCï¼ˆTensor Processor Coreï¼‰](#tpctensor-processor-core)
  - [ğŸ“ˆ MME ä¸ TPC ååŒå…³ç³»](#mme-ä¸-tpc-ååŒå…³ç³»)
  - [ğŸ” MME vs TPC æ€»ç»“å¯¹æ¯”è¡¨](#mme-vs-tpc-æ€»ç»“å¯¹æ¯”è¡¨)
  - [ğŸ”¤ é™„æ³¨ï¼šæœ¯è¯­è§£é‡Š](#é™„æ³¨æœ¯è¯­è§£é‡Š)
- [ğŸ§  Intel Gaudi 3 TPC æ¨¡å—ï¼šç”¨æˆ·å¯ç¼–ç¨‹èƒ½åŠ›æ€»ç»“](#intel-gaudi-3-tpc-ç”¨æˆ·å¯ç¼–ç¨‹èƒ½åŠ›æ€»ç»“)
  - [ğŸ“Œ TPC ç®€ä»‹](#tpc-ç®€ä»‹)
  - [ğŸ’» ç¼–ç¨‹è¯­è¨€ï¼šTPC-Cï¼ˆC99 è¡ç”Ÿï¼‰](#ç¼–ç¨‹è¯­è¨€tpc-cc99-è¡ç”Ÿ)
  - [ğŸ”¢ æ”¯æŒçš„æ•°æ®ç±»å‹ï¼ˆSIMD å‘é‡ç±»å‹ï¼‰](#æ”¯æŒçš„æ•°æ®ç±»å‹simd-å‘é‡ç±»å‹)
  - [ğŸ§  å†…å­˜æ¨¡å‹](#å†…å­˜æ¨¡å‹)
  - [ğŸ§ª å†…å»ºå…¨å±€å˜é‡ & å‡½æ•°ï¼ˆéšæœºæ•°ã€Lane ID ç­‰ï¼‰](#å†…å»ºå…¨å±€å˜é‡--å‡½æ•°éšæœºæ•°lane-id-ç­‰)
  - [ğŸ“ˆ ä½¿ç”¨åœºæ™¯ä¸è°ƒä¼˜å»ºè®®](#ä½¿ç”¨åœºæ™¯ä¸è°ƒä¼˜å»ºè®®)
  - [ğŸ› ï¸ ç¤ºä¾‹ï¼šTPC å†…æ ¸ç¼–å†™](#ç¤ºä¾‹å†…æ ¸ç¼–å†™)
  - [ğŸ“š æ€»ç»“](#æ€»ç»“)

---



## Intel Gaudi 3 AI åŠ é€Ÿå™¨å…³é”®è§„æ ¼æ€»ç»“ï¼ˆé¢å‘å¤§æ¨¡å‹æ¨ç†éƒ¨ç½²ï¼‰

Intel Gaudi 3 æ˜¯ä¸€æ¬¾ä¸º AI æ¨ç†å’Œè®­ç»ƒè®¾è®¡çš„é«˜æ€§èƒ½åŠ é€Ÿå™¨ï¼Œå…¶ç¡¬ä»¶æ¶æ„ä¸æ•°æ®ä¼ è¾“è®¾è®¡ä¸“ä¸ºæ·±åº¦å­¦ä¹ å·¥ä½œè´Ÿè½½ï¼ˆå°¤å…¶æ˜¯å¤§è¯­è¨€æ¨¡å‹ LLMï¼‰è¿›è¡Œäº†ä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯ä¸ LLM æ¨ç†éƒ¨ç½²å’Œæ€§èƒ½è°ƒä¼˜å¯†åˆ‡ç›¸å…³çš„æ ¸å¿ƒç¡¬ä»¶æŒ‡æ ‡ä¸ç‰¹æ€§ã€‚

### æ ¸å¿ƒè®¡ç®—èƒ½åŠ›

| æŒ‡æ ‡ç±»å‹                   | Gaudi 2 | **Gaudi 3** | å¢å¹…        | è¯´æ˜                          |
| ---------------------- | ------- | ----------- | --------- | --------------------------- |
| **FP8 GEMM TFLOPS**    | 865     | **1678**    | >1.9Ã—     | é«˜æ•ˆæ”¯æŒ Transformer ä¸­ä¸»å¹² matmul |
| **BF16 GEMM TFLOPS**   | 432     | **1678**    | **>3.8Ã—** | æ›´é€‚åˆç²¾åº¦æ•æ„Ÿå‹æ¨ç†                  |
| **Vector BF16 TFLOPS** | 11      | **28.7**    | 2.6Ã—      | éçŸ©é˜µç±»è¿ç®—èƒ½åŠ›æå‡                  |
| **MME å•å…ƒæ•°**            | 2       | **8**       | 4Ã—        | å¹¶è¡ŒçŸ©é˜µä¹˜å¤„ç†èƒ½åŠ›ç¿»å€                 |
| **TPC å•å…ƒæ•°**            | 24      | **64**      | 2.67Ã—     | ç”¨äºå¤„ç†é GEMM æ“ä½œï¼ˆå¦‚æ¿€æ´»å‡½æ•°ã€å½’ä¸€åŒ–ï¼‰    |

> ğŸ’¡ **MME**ï¼šMatrix Multiplication Engineï¼Œä¸»è¦è´Ÿè´£ Transformer æ¨¡å‹ä¸­çš„ FCã€Convã€BatchGEMM ç­‰æ“ä½œ
> ğŸ’¡ **TPC**ï¼šTensor Processing Clusterï¼Œæ˜¯ VLIW SIMD æ¶æ„ï¼Œç”¨äºéçŸ©é˜µè¿ç®—ï¼ˆå¦‚ Softmaxã€LayerNormï¼‰

[![Gaudi 3 Block](diagram/gaudi3_block.png)](https://raw.githubusercontent.com/zongwave/pixelcraft/main/ai/llm/hpu/diagram/gaudi3_block.png)

### å­˜å‚¨ä¸å¸¦å®½

| æŒ‡æ ‡ç±»å‹               | Gaudi 2      | **Gaudi 3**       | å¢å¹…      | è¯´æ˜                      |
| ------------------ | ------------ | ----------------- | ------- | ----------------------- |
| **HBM å®¹é‡**         | 96 GB        | **128 GB**        | 1.33Ã—   | æ”¯æŒæ›´å¤§å‚æ•°æ¨¡å‹å’Œ KV cache      |
| **HBM å¸¦å®½**         | 2.46 TB/s    | **3.7 TB/s**      | 1.5Ã—    | å…³é”®æå‡æ¨ç†ååä¸ KV-cache è¯»å–æ•ˆç‡ |
| **On-die SRAM å®¹é‡** | 48 MB        | **96 MB**         | 2Ã—      | æå‡å¯„å­˜å±€éƒ¨è®¡ç®—æ€§èƒ½              |
| **On-die SRAM å¸¦å®½** | 6.4/6.4 TB/s | **12.8/6.4 TB/s** | read ç¿»å€ | é™ä½è®¿é—®ä¸»å­˜é¢‘ç‡ã€åŠ é€Ÿç®—å­           |

### IO ä¸ç³»ç»Ÿäº’è”

| æŒ‡æ ‡ç±»å‹            | Gaudi 2         | **Gaudi 3**          | å¢å¹…    | è¯´æ˜             |
| --------------- | --------------- | -------------------- | ----- | -------------- |
| **ç½‘ç»œäº’è”å¸¦å®½ï¼ˆåŒå‘ï¼‰**  | 600 GB/s        | **1200 GB/s**        | 2Ã—    | é€‚åˆå¤§è§„æ¨¡å¤šå¡æ¨¡å‹åˆ†å¸ƒæ¨ç†  |
| **Host æ¥å£**     | PCIe Gen4 x16   | **PCIe Gen5 x16**    | 2Ã— å¸¦å®½ | æ›´å¿«ä¸»æœº-è®¾å¤‡æ•°æ®äº¤æ¢    |
| **Host æ¥å£å¸¦å®½å³°å€¼** | 64 GB/s (32/32) | **128 GB/s (64/64)** | 2Ã—    | åŠ å¿«è¾“å…¥è¾“å‡ºä¼ è¾“ä¸æ§åˆ¶ä¿¡ä»¤  |
| **è§†é¢‘è§£ç å™¨æ•°é‡**     | 8               | 14                   | â€”     | åŠ é€Ÿå¤šæ¨¡æ€åœºæ™¯ä¸­çš„åª’ä½“é¢„å¤„ç† |

### æ¶æ„ç‰¹æ€§ä¸ä¼˜åŒ–é‡ç‚¹

* **åŒèŠ¯ç‰‡å°è£… + é«˜å¸¦å®½æ¡¥æ¥äº’è¿**ï¼šå•èŠ¯ç‰‡å°è£…çš„é€æ˜åŒ–äº’è”è®¾è®¡ï¼Œåœ¨è½¯ä»¶ä¸Šç­‰æ•ˆäºå•ä¸€å¤§èŠ¯ç‰‡ï¼Œä¾¿äºé«˜æ•ˆä½¿ç”¨æ‰€æœ‰è®¡ç®—èµ„æºã€‚
* **å¼‚æ„è®¡ç®—å¼•æ“ï¼ˆMME + TPCï¼‰**ï¼šå¯é’ˆå¯¹ LLM ä¸­ä¸»å¹²è·¯å¾„ï¼ˆmatmulï¼‰ä¸è¾…åŠ©æ“ä½œï¼ˆæ¿€æ´»ã€å½’ä¸€åŒ–ï¼‰åˆ†åˆ«ä¼˜åŒ–è°ƒåº¦ã€‚
* **FP8 / BF16 æ”¯æŒ**ï¼šç¬¦åˆä¸»æµ LLM æ¨¡å‹è®­ç»ƒä¸æ¨ç†çš„ä½ç²¾åº¦è§„èŒƒï¼Œå¹³è¡¡ååä¸ç²¾åº¦ã€‚

---

### æ¨ç†éƒ¨ç½²ä¼˜åŒ–å»ºè®®

1. **å¤§æ¨¡å‹ KV-cache ä¼˜åŒ–**ï¼šåˆ©ç”¨ 128GB HBM å’Œ 12.8TB/s SRAM è¯»å¸¦å®½ï¼Œå®ç°é«˜æ•ˆç¼“å­˜ä¸æŸ¥è¡¨æ“ä½œã€‚
2. **æ¨¡å‹å¹¶è¡Œæ¨è**ï¼š

   * ä½¿ç”¨ TPC æ‰§è¡Œ token-wise æ“ä½œï¼ˆå¦‚ LayerNormã€Softmaxï¼‰ï¼›
   * åˆ©ç”¨ 8 ä¸ª MME å•å…ƒæ‰§è¡Œå¤§è§„æ¨¡ FC/WQKV ä¹˜æ³•ã€‚
3. **é€šä¿¡ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨ 1200GB/s ç½‘ç»œå¸¦å®½ï¼Œåœ¨å¤šå¡æ¨ç†ä¸­ä½¿ç”¨ Ring/AllReduce/Broadcast é€šä¿¡ä¼˜åŒ–ç­–ç•¥ã€‚
4. **Host-Device æ•°æ®é¢„å–**ï¼šç»“åˆ PCIe Gen5 é«˜å¸¦å®½ï¼Œæå‰åŠ è½½ prompt/token embeddingï¼Œå¯å‡å°‘ latencyã€‚

---


## Intel Gaudi 3 AI åŠ é€Ÿå™¨æ¶æ„æ¦‚è¦

### MMEï¼ˆMatrix Multiplication Engineï¼‰

[![MME Engine Block](diagram/mme.png)](https://raw.githubusercontent.com/zongwave/pixelcraft/main/ai/llm/hpu/diagram/mme.png)


#### åŠŸèƒ½å®šä½

ä¸“ç”¨äºçŸ©é˜µä¹˜æ³•ç›¸å…³è®¡ç®—ä»»åŠ¡ï¼ˆå¦‚ FC å±‚ã€Convã€BatchGEMMï¼‰ï¼Œæ˜¯å¤§æ¨¡å‹ä¸­æ‰§è¡Œ GEMM è¿ç®—çš„æ ¸å¿ƒæ¨¡å—ã€‚

#### æ¶æ„è§„æ ¼

* **æ•°é‡**ï¼š8 ä¸ª MME å•å…ƒ
* **æ¯ä¸ª MME**ï¼š

  * å†…å« **64K Multiply-Accumulate Units (MACs)**
  * é«˜å¹¶è¡Œåº¦æ‰§è¡ŒçŸ©é˜µä¹˜æ³•
* **æ€§èƒ½æŒ‡æ ‡**ï¼š

  * **Peak FP8/BF16 GEMM Throughput**ï¼š1678 TFLOPSï¼ˆæ•´å¡ï¼‰
* **æ•°æ®è°ƒåº¦æœºåˆ¶**ï¼š

  * æ”¯æŒ **åŸºäºå…±äº«ç»´åº¦ K çš„åˆ‡åˆ†**ï¼Œä¸åŒ MME å¯¹ A å’Œ B çš„åˆ‡ç‰‡è¿›è¡Œå¹¶è¡Œä¹˜æ³•
  * æ”¯æŒ **æ™ºèƒ½ç¼“å­˜å¤ç”¨**ï¼šå¦‚ MME0ã€MME2ã€MME4ã€MME6 å¯å…±äº« A çš„ä¸ŠåŠéƒ¨åˆ†
* **å†…å­˜è®¿é—®**ï¼š

  * æ•°æ®ä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œå‡å°‘ HBM è®¿é—®
  * ä¸ HBM é«˜é€Ÿå¸¦å®½ï¼ˆ3.7 TB/sï¼‰æ·±åº¦ååŒ

#### æ¨ç†è°ƒä¼˜ç›¸å…³è¦ç‚¹

* MME æ˜¯æ‰§è¡Œå¤§æ¨¡å‹ä¸­ Attentionã€MLP ä¸­ FC å±‚çš„ä¸»è¦ç®—å­ä½ç½®
* ä¼˜åŒ–ç‚¹åŒ…æ‹¬ï¼š

  * å‡å°‘å†…å­˜å¸¦å®½å‹åŠ›ï¼ˆæå‰ç¼“å­˜è¾“å…¥ï¼‰
  * æŒ‰ç…§ MME çš„åˆ‡åˆ†é€»è¾‘ç»„ç»‡è¾“å…¥å¼ é‡
  * Graph Compiler ä¼šæ ¹æ®è¾“å…¥å½¢çŠ¶ã€K ç»´åº¦é€‰æ‹©æœ€ä½³å¹¶è¡Œç­–ç•¥

---

### TPCï¼ˆTensor Processor Coreï¼‰

[![TPC Block](diagram/tpc.png)](https://raw.githubusercontent.com/zongwave/pixelcraft/main/ai/llm/hpu/diagram/tpc.png)


#### åŠŸèƒ½å®šä½

å¤„ç†é-GEMM ç±»å‹è®¡ç®—ï¼ˆå¦‚ LayerNormã€æ¿€æ´»å‡½æ•°ã€ç´¢å¼•æ“ä½œï¼‰ï¼Œå¯æ‰§è¡Œä»»æ„å¼ é‡æ“ä½œã€‚

#### æ¶æ„è§„æ ¼

* **æ•°é‡**ï¼š64 ä¸ª
* **VLIW SIMD æ¶æ„**ï¼š

  * 256 Byte å®½åº¦
  * æ”¯æŒå¤šç§ç²¾åº¦æ ¼å¼ï¼ˆFP32ã€FP16ã€BF16ã€FP8-E4M3/E5M2ï¼Œä»¥åŠ INT/UINT8\~32ï¼‰
* **å­æ¨¡å—**ï¼š

  * **Scalar Unit / Vector Processing Unit**
  * **Tensor Register File**
  * **Load/Store Unit**
  * **L1 Cache**

#### ç‰¹æ€§äº®ç‚¹

* **DMA-Free æ¶æ„**ï¼šTPC å†…éƒ¨å¯è‡ªåŠ¨å¤„ç†å¼ é‡è½½å…¥ï¼Œæ— éœ€æ˜¾å¼ DMA æ§åˆ¶
* **å¾®ç§’çº§ Kernel æ”¯æŒ**ï¼šå³ä½¿æ˜¯çŸ­å°æ ¸å‡½æ•°ä¹Ÿå¯è·å¾—é«˜åˆ©ç”¨ç‡
* **æµæ°´çº¿ä¼˜åŒ–**ï¼šå¤šä¸ªå†…æ ¸å¯æ— ç¼è¿ç»­æ‰§è¡Œï¼Œæ¶ˆé™¤ pipeline ç©ºæ´
* **æ”¯æŒå¤æ‚æ•°æ®è·¯å¾„**ï¼šæ”¯æŒ cache / HBM è¾“å…¥ï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨åˆ†é…

#### æ¨ç†è°ƒä¼˜ç›¸å…³è¦ç‚¹

* LayerNormã€GELUã€Mask ç­‰æ“ä½œæ›´é€‚åˆåˆ†é…ç»™ TPC
* åˆ©ç”¨ TPC æ”¯æŒå¤šæ•°æ®ç±»å‹ï¼Œåœ¨æ¨ç†é˜¶æ®µåˆç†é€‰å– BF16 / INT8 å¯æå‡æ€§èƒ½
* åˆ©ç”¨ TPC çš„ä½å»¶è¿Ÿä¼˜åŠ¿å¤„ç†å°è§„æ¨¡é€å…ƒç´ è¿ç®—ï¼Œå‡è½»ä¸»æ ¸å‹åŠ›

---

### MME ä¸ TPC ååŒå…³ç³»

| æ¨¡å—ç±»å‹    | ä¸»è¦ç”¨é€”    | å…¸å‹ä»»åŠ¡               | å¹¶è¡Œç­–ç•¥        | æ˜¯å¦é€‚åˆ FP8       | é€‚åˆå° batch |
| ------- | ------- | ------------------ | ----------- | -------------- | --------- |
| **MME** | å¤§å‹çŸ©é˜µä¹˜æ³•  | FC, Attention QK/V | å¤š MME K ç»´åˆ‡ç‰‡ | âœ… Yes          | âŒ ä¸é€‚åˆ     |
| **TPC** | æ ‡é‡/å‘é‡æ“ä½œ | LayerNorm, Softmax | SIMD å¹¶è¡Œ     | âœ… æ”¯æŒ FP8 & INT | âœ… æ”¯æŒçŸ­å°æ ¸   |

---

### MME vs TPC æ€»ç»“å¯¹æ¯”è¡¨

| ç‰¹å¾   | MME                  | TPC                  |
| ---- | -------------------- | -------------------- |
| ä¸»è¦ç”¨é€” | GEMM / BatchGEMM     | é€šç”¨å¼ é‡è®¡ç®—               |
| è®¡ç®—ç»“æ„ | é«˜ååçŸ©é˜µä¹˜å•å…ƒ             | SIMD + VLIW å¼ é‡æ ¸      |
| ååç‰¹ç‚¹ | é«˜ååä½†éœ€è¦å¤§çŸ©é˜µä»¥å……åˆ†åˆ©ç”¨       | å°ä»»åŠ¡ä¹Ÿå¯é«˜æ•ˆåˆ©ç”¨            |
| ç¼–ç¨‹æ¥å£ | ç¼–è¯‘å™¨è°ƒåº¦ï¼ˆä¸å¯ç¼–ç¨‹ï¼‰          | å¯ç¼–ç¨‹ï¼Œé«˜çµæ´»æ€§             |
| ä½¿ç”¨åœºæ™¯ | FC/Attention/QKV çŸ©é˜µä¹˜ | æ¿€æ´»ã€å½’ä¸€åŒ–ã€ä½ç½®ç¼–ç ç­‰         |
| å…¸å‹ç²¾åº¦ | BF16 / FP16          | FP32 / BF16 / INT8 ç­‰ |

---

### é™„æ³¨ï¼šæœ¯è¯­è§£é‡Š

* **GEMM**ï¼šGeneral Matrix Multiplyï¼Œè¡¨ç¤ºä¸€èˆ¬çŸ©é˜µä¹˜æ³• `C = A Ã— B`ã€‚
* **Batch GEMM**ï¼šå¯¹å¤šä¸ª GEMM ä»»åŠ¡åŒæ—¶è¿›è¡Œè®¡ç®—ï¼Œæå‡åˆ©ç”¨ç‡ï¼ˆå¦‚ä¸€ä¸ª batch çš„å¤šä¸ªæ ·æœ¬ï¼‰ã€‚
* **MACï¼ˆMultiply-Accumulateï¼‰**ï¼šä¹˜åŠ å•å…ƒï¼Œæ˜¯ç¥ç»ç½‘ç»œä¸­æ ¸å¿ƒçš„è®¡ç®—å•å…ƒã€‚

---

ä»¥ä¸‹æ˜¯å¯¹ Intel Gaudi 3 åŠ é€Ÿå™¨ä¸­ **TPC æ¨¡å—çš„ç”¨æˆ·å¯ç¼–ç¨‹æ€§**çš„æ€»ç»“ï¼Œé‡ç‚¹æ•´ç†äº†ä¸å¤§æ¨¡å‹æ¨ç†éƒ¨ç½²ã€ç®—å­è‡ªå®šä¹‰ã€ä¼˜åŒ–ç›¸å…³çš„ç¼–ç¨‹æ¨¡å‹ã€å†…å­˜æ¨¡å‹å’Œå¯ç”¨çš„ SIMD æ•°æ®ç±»å‹ã€‚
---

## Intel Gaudi 3 TPC ç”¨æˆ·å¯ç¼–ç¨‹èƒ½åŠ›æ€»ç»“

### TPC ç®€ä»‹

**TPCï¼ˆTensor Processor Coreï¼‰** æ˜¯ Gaudi åŠ é€Ÿå™¨ä¸­çš„å¯ç¼–ç¨‹æ ¸å¿ƒï¼Œä¸“ä¸ºæ‰§è¡Œéçº¿æ€§æ·±åº¦å­¦ä¹ ç®—å­ï¼ˆå¦‚ BatchNormã€Poolingã€LayerNorm ç­‰ï¼‰è€Œè®¾è®¡ã€‚å…¶ç‰¹ç‚¹åŒ…æ‹¬ï¼š

* âœ… **VLIW4 SIMD æ¶æ„**ï¼ˆVery Long Instruction Word + Single Instruction Multiple Dataï¼‰
* âœ… é¢å‘é«˜ååã€ä½å»¶è¿Ÿçš„é GEMM æ“ä½œä¼˜åŒ–
* âœ… æ”¯æŒ **ç”¨æˆ·ä½¿ç”¨ç±» C è¯­è¨€ç¼–å†™å†…æ ¸å‡½æ•°**ï¼ˆTPC-Cï¼‰

---

### ç¼–ç¨‹è¯­è¨€ï¼šTPC-Cï¼ˆC99 è¡ç”Ÿï¼‰

TPC ä½¿ç”¨ä¸€ç§åŸºäº C99 çš„è¯­è¨€ TPC-C ç¼–å†™ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

* **ç±» C è¯­æ³•**ï¼Œæ”¯æŒå‡½æ•°ã€å˜é‡ã€æ§åˆ¶æµ
* æ‰©å±•æ•°æ®ç±»å‹ç”¨äºå‘é‡è®¡ç®—ï¼ˆè§ä¸‹æ–‡ï¼‰
* æ— éœ€æ˜¾å¼æ§åˆ¶ DMAï¼ˆTPC è‡ªåŠ¨è°ƒåº¦ tensor è¯»å†™ï¼‰
* åªèƒ½é€šè¿‡å†…å»º intrinsics æ“ä½œå†…å­˜åœ°å€ï¼ˆå¦‚ `a_gen_addr_i_b()`ï¼‰

---

### æ”¯æŒçš„æ•°æ®ç±»å‹ï¼ˆSIMD å‘é‡ç±»å‹ï¼‰

TPC æ”¯æŒå¤šç§å†…å»ºå‘é‡ç±»å‹ç”¨äºå¤§è§„æ¨¡å¹¶è¡Œè¿ç®—ï¼š

| ç±»å‹å         | è¯´æ˜                        |
| ----------- | ------------------------- |
| `float64`   | 64 Ã— float32              |
| `bfloat128` | 128 Ã— bfloat16            |
| `ushort128` | 128 Ã— int16/uint16        |
| `int64`     | 64 Ã— int32                |
| `uint64`    | 64 Ã— uint32               |
| `char256`   | 256 Ã— int8                |
| `uchar256`  | 256 Ã— uint8               |
| `bool256`   | 256 Ã— 1-bit boolï¼ˆä»…æ”¯æŒé€»è¾‘è¿ç®—ï¼‰ |
| `int5`      | å¼ é‡åç§»çš„ 5D åæ ‡ï¼ˆå¼ é‡ä¸‹æ ‡ï¼‰         |
| `tensor`    | æŒ‡å‘å¼ é‡å¯¹è±¡çš„ opaque handle     |

> æ¯ä¸ª TPC æ ¸å¿ƒæ¯å‘¨æœŸå¯å¤„ç†ï¼š
>
> * 64 Ã— float32 / int32 ops
> * 128 Ã— int16 ops
> * 256 Ã— int8 ops

---

### å†…å­˜æ¨¡å‹

#### ğŸ§© Global Memoryï¼ˆå…¨å±€å†…å­˜ï¼‰

* ç”¨äºå­˜æ”¾å¼ é‡ï¼ˆç”± Gaudi runtime åˆ†é…ï¼Œç”¨æˆ·ä¸å¯åŠ¨æ€ç”³è¯·ï¼‰
* åœ°å€åˆå§‹åŒ–éœ€ç”¨å†…å»ºå‡½æ•° `a_gen_addr_*`
* éä¸€è‡´æ€§ï¼ˆéœ€è°ƒç”¨ `aso()` ç¡®ä¿è¯»åå†™è¯­ä¹‰ï¼‰
* æ— æ³•ä½¿ç”¨ `malloc/free`
* ä½¿ç”¨ `__global__` ä¿®é¥°ç¬¦å£°æ˜å…¨å±€æŒ‡é’ˆ

ç¤ºä¾‹ï¼š

```c
__global__ int* ptr = a_gen_addr_i_b(tensor_obj, offset);
int tmp = *ptr;
*ptr = tmp + 1;
```

#### ğŸ”’ é™åˆ¶ï¼š

* ä¸å¯ä½¿ç”¨å…¨å±€æŒ‡é’ˆè®¿é—®å±€éƒ¨å˜é‡
* ä¸å¯é™æ€å£°æ˜å…¨å±€æ•°ç»„ï¼ˆéæ³•ï¼‰ï¼š`__global__ int64 array[64];`

---

#### ğŸ§© Local Memoryï¼ˆå±€éƒ¨å†…å­˜ï¼‰

* æ¯ä¸ª TPC æ ¸å¿ƒæœ‰ç‹¬ç«‹çš„å±€éƒ¨å†…å­˜
* æ”¯æŒ **é™æ€åˆ†é…**ï¼ˆç¼–è¯‘æœŸï¼‰ï¼Œä¸æ”¯æŒåŠ¨æ€åˆ†é…
* ä½¿ç”¨ `__local__` ä¿®é¥°ç¬¦å®šä¹‰
* è‡ªåŠ¨é¡ºåºä¸€è‡´æ€§ï¼ˆä¸éœ€ memory barrierï¼‰

å¤§å°è§„æ ¼ï¼š

* **æ ‡é‡ç±»å‹ï¼š1 KB**
* **å‘é‡ç±»å‹ï¼š16 KBï¼ˆè‹¥ç”¨ç‰¹æ®Šå‡½æ•°åˆ™ä¸º 80 KBï¼‰**

ç¤ºä¾‹ï¼š

```c
__local__ float64 constants[3];
constants[0] = v_f32_ld_tnsr_i_b(coord, inputA, 1, 0);
```

---

### å†…å»ºå…¨å±€å˜é‡ & å‡½æ•°ï¼ˆéšæœºæ•°ã€Lane ID ç­‰ï¼‰

#### ğŸ”„ ä¼ªéšæœºæ•°ï¼ˆLFSRï¼‰

* `read_lfsr_b()`ï¼šè¿”å› `char256` éšæœºå‘é‡ï¼ˆç ´åæ€§è¯»å–ï¼‰
* `write_lfsr_b(seed)`ï¼šè®¾ç½®ç§å­

ç¤ºä¾‹ï¼š

```c
char256 rand = read_lfsr_b();
```

#### ğŸ§© LANE IDï¼ˆå‘é‡ lane ID è·å–ï¼‰

* `read_lane_id_4b_b()` â†’ è¿”å› `uint64`ï¼ˆ64 Ã— int32ï¼‰
* `read_lane_id_2b_b()` â†’ è¿”å› `ushort128`
* `read_lane_id_1b_b()` â†’ è¿”å› `uchar256`

ç»“åˆæ©ç æ“ä½œç¤ºä¾‹ï¼š

```c
uint64 lane_id_32 = read_lane_id_4b_b();
bool256 mask = bv_u32_cmp_eq_v_s(lane_id_32, 7);
float64 result = v_f32_mov_s_vb(val, result, mask, 0);
```

---

### ä½¿ç”¨åœºæ™¯ä¸è°ƒä¼˜å»ºè®®

| åœºæ™¯                        | æ˜¯å¦æ¨èä½¿ç”¨ TPC | åŸå› /è¯´æ˜                 |
| ------------------------- | ---------- | --------------------- |
| LayerNorm / GELU / SiLU ç­‰ | âœ… æ˜¯        | å°å‹é€å…ƒç´ ç®—å­ï¼ŒTPC SIMD é«˜æ•ˆæ‰§è¡Œ |
| ArgMax / TopK / Sort      | âœ… æ˜¯        | å¯é€šè¿‡æ‰‹åŠ¨å®ç°å‘é‡æ¯”è¾ƒä¸æ›¿æ¢        |
| BatchNorm / Pooling       | âœ… æ˜¯        | éçº¿æ€§ç»“æ„ï¼ŒMME ä¸æ”¯æŒ         |
| Attention QK/VO çŸ©é˜µä¹˜æ³•      | âŒ å¦        | åº”ä½¿ç”¨ MME è¿›è¡Œ GEMM       |
| å¤§æ¨¡å‹ä¸­è‡ªå®šä¹‰ç²¾åº¦æ ¸å‡½æ•°              | âœ… æ˜¯        | å¯ç”¨ INT8/FP8 æ‰‹åŠ¨å®ç°è½»é‡çº§ç®—å­ |

---


### ç¤ºä¾‹ï¼šå†…æ ¸ç¼–å†™


```c
__local__ int localArray[5];

void main (tensor t1)
{
  int5 offset = {0,1,2,3,3};
  __global__ int* pointer = a_gen_addr_i_b(t1, offset);
  int tmp = *pointer;
  tmp = tmp + localArray[0];
  *pointer = tmp;
}
```

---

### æ€»ç»“

* TPC æä¾›äº†é«˜åº¦å¯æ§çš„ SIMD ç¼–ç¨‹æ¨¡å‹ï¼Œé€‚åˆç”¨äºæ¨ç†é˜¶æ®µçš„ç»†ç²’åº¦ä¼˜åŒ–ä¸ç®—å­èåˆã€‚
* ç”¨æˆ·å¯åŸºäº C99 è¡ç”Ÿè¯­è¨€ï¼Œçµæ´»å®šä¹‰éçŸ©é˜µæ“ä½œç®—å­ã€‚
* æ¨èæŒæ¡ TPC ç¼–ç¨‹ç”¨äºè‡ªå®šä¹‰ LayerNormã€Indexingã€Activation ç­‰æ¨ç†å…³é”®è·¯å¾„ã€‚
* æ­é… Graph Compilerï¼Œå¯å®ç° MME + TPC çš„ä»»åŠ¡æ‹†åˆ†ä¸è°ƒåº¦ååŒã€‚

---





---


